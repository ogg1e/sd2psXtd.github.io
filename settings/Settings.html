<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>sd2psXtd Settings Generator</title>
  <style>
    /* Dark/light mode variables */
    :root {
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-color: #333;
      --border-color: #ddd;
      --button-bg: #007bff;
      --button-color: #fff;
      --button-hover: #0056b3;
      --header-bg: #e0e0e0;
      --header-text: #000;
      --checkbox-border: #666;
      --checkbox-checked: #007bff;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --border-color: #333;
        --button-bg: #0a84ff;
        --button-hover: #0060d0;
        --header-bg: #333;
        --header-text: #fff;
        --checkbox-border: #aaa;
        --checkbox-checked: #0a84ff;
      }
    }
    /* Basic reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background-color: var(--bg-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-color);
      padding: 20px;
    }
    .container {
      background-color: var(--card-bg);
      padding: 30px;
      border-radius: 12px;
      max-width: 900px;
      margin: 0 auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    /* Drop Zone */
    #dropZone {
      border: 2px dashed var(--border-color);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      border-radius: 8px;
      margin-bottom: 20px;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    #dropZone.hover {
      background-color: rgba(0, 0, 0, 0.05);
      border-color: var(--button-bg);
    }
    fieldset {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px 20px;
      margin-bottom: 20px;
    }
    legend {
      padding: 0 10px;
      font-weight: bold;
    }
    label {
      font-size: 0.95rem;
      cursor: pointer;
    }
    /* Modern dropdown styling */
    select {
      width: 100%;
      padding: 8px 12px;
      margin-top: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="%23666" viewBox="0 0 10 10"><path d="M0 2l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 10px;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
    }
    /* Modernized checkboxes for all */
    input[type="checkbox"].modern-checkbox {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid var(--checkbox-border);
      border-radius: 4px;
      display: inline-block;
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    input[type="checkbox"].modern-checkbox:checked {
      background-color: var(--checkbox-checked);
      border-color: var(--checkbox-checked);
    }
    input[type="checkbox"].modern-checkbox:checked::after {
      content: 'âœ”';
      font-size: 14px;
      color: white;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -55%);
      font-weight: bold;
    }
    /* Container for checkbox groups to center them horizontally */
    .checkbox-container {
      display: flex;
      justify-content: space-evenly;
      align-items: center;
    }
    /* Modernized PS1 Boot Cards Table */
    #ps1bootcards table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #ps1bootcards th {
      background-color: var(--header-bg);
      color: var(--header-text);
      padding: 12px;
      font-size: 1rem;
      text-align: center;
      border-bottom: 2px solid var(--border-color);
    }
    #ps1bootcards td {
      padding: 12px;
      vertical-align: top;
      border-bottom: 1px solid var(--border-color);
    }
    #ps1bootcards ul {
      list-style: none;
      padding-left: 0;
    }
    #ps1bootcards li {
      margin-bottom: 8px;
    }
    #ps1bootcards label {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #ps1bootcards tr:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    /* PS2 BootCards Table formatted like PS1 BootCards */
    #ps2bootcards table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #ps2bootcards th {
      background-color: var(--header-bg);
      color: var(--header-text);
      padding: 12px;
      font-size: 1rem;
      text-align: center;
      border-bottom: 2px solid var(--border-color);
      width: 50%;
    }
    #ps2bootcards td {
      padding: 12px;
      vertical-align: top;
      border-bottom: 1px solid var(--border-color);
      width: 50%;
    }
    /* Remove bullet points in PS2 BootCards unordered lists */
    #ps2bootcards ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    /* Container used for CardSize, Mode and Variant selections */
    .cardsize-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .cardsize-container label {
      margin: 0;
    }
    /* Hide file input */
    input[type="file"] {
      display: none;
    }
    button {
      display: block;
      width: 100%;
      padding: 12px;
      background-color: var(--button-bg);
      color: var(--button-color);
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: var(--button-hover);
    }
  </style>
</head>
<body>
  <div class="container">
    <form id="settingsForm">
      <h2>sd2psXtd Settings Generator</h2>
      <!-- Drop zone for importing an INI file -->
      <div id="dropZone">Drag and drop your INI file here, or click to browse.</div>
      <input type="file" id="iniFile" accept=".ini, .txt">

      <fieldset>
        <legend>General</legend>
        <div class="cardsize-container">
          <label for="Mode">Mode:</label>
          <select name="Mode" id="Mode">
            <option value="PS1">PS1</option>
            <option value="PS2" selected>PS2</option>
          </select>
        </div>
        <br/>
        <div class="checkbox-container">
          <label>
            <input type="checkbox" class="modern-checkbox" name="FlippedScreen" id="FlippedScreen">
            Flipped Screen
          </label>
        </div>
      </fieldset>

      <fieldset>
        <legend>PS1</legend>
        <div class="checkbox-container">
          <label>
            <input type="checkbox" class="modern-checkbox" name="PS1_Autoboot" id="PS1_Autoboot" checked>
            Autoboot
          </label>
          <label>
            <input type="checkbox" class="modern-checkbox" name="PS1_GameID" id="PS1_GameID" checked>
            GameID
          </label>
        </div>
      </fieldset>

      <fieldset>
        <legend>PS2</legend>
        <!-- Drop downs first -->
        <div class="cardsize-container">
          <label for="PS2_CardSize">CardSize:</label>
          <select name="PS2_CardSize" id="PS2_CardSize">
            <option value="1">1 MB</option>
            <option value="2">2 MB</option>
            <option value="4">4 MB</option>
            <option value="8" selected>8 MB</option>
            <option value="16">16 MB</option>
            <option value="32">32 MB</option>
            <option value="64">64 MB</option>
          </select>
        </div>
        <div class="cardsize-container">
          <label for="PS2_Variant">Variant:</label>
          <select name="PS2_Variant" id="PS2_Variant">
            <option value="RETAIL" selected>Retail</option>
            <option value="PROTO">Proto</option>
            <option value="ARCADE">Arcade</option>
          </select>
        </div>
         <br/>
         <div class="checkbox-container">
           <label>
             <input type="checkbox" class="modern-checkbox" name="PS2_Autoboot" id="PS2_Autoboot" checked>
             Autoboot
           </label>
           <label>
             <input type="checkbox" class="modern-checkbox" name="PS2_GameID" id="PS2_GameID" checked>
             GameID
           </label>
         </div>
      </fieldset>

      <!-- PS1 Boot Cards Section -->
      <fieldset id="ps1bootcards">
        <legend>PS1 Boot Cards</legend>
        <table>
          <thead>
            <tr>
              <th>Region I</th>
              <th>Region A</th>
              <th>Region E</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <!-- Region I -->
              <td>
                <ul>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH1000_I_1.0" data-ini-key="SCPH-1000 (I) 1.0">
                      SCPH-1000 (I) v1.0
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH3000_I_1.1" data-ini-key="SCPH-3000 (I) 1.1">
                      SCPH-3000 (I) v1.1
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH3500_I_2.1" data-ini-key="SCPH-3500 (I) 2.1">
                      SCPH-3500 (I) v2.1
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH5000_I_2.2" data-ini-key="SCPH-5000 (I) 2.2">
                      SCPH-5000 (I) v2.2
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH5500_I_3.0" data-ini-key="SCPH-5500 (I) 3.0">
                      SCPH-5500 (I) v3.0
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH7000_I_4.0" data-ini-key="SCPH-7000 (I) 4.0">
                      SCPH-7000 (I) v4.0
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH100_I_4.3" data-ini-key="SCPH-100 (I) 4.3">
                      SCPH-100 (I) v4.3
                    </label>
                  </li>
                </ul>
              </td>
              <!-- Region A -->
              <td>
                <ul>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH1001_A_2.0" data-ini-key="SCPH-1001 (A) 2.0">
                      SCPH-1001 (A) v2.0
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH1001_A_2.1" data-ini-key="SCPH-1001 (A) 2.1">
                      SCPH-1001 (A) v2.1
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH1001_A_2.2" data-ini-key="SCPH-1001 (A) 2.2">
                      SCPH-1001 (A) v2.2
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH5003_A_2.2" data-ini-key="SCPH-5003 (A) 2.2">
                      SCPH-5003 (A) v2.2
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH5001_A_3.0" data-ini-key="SCPH-5001 (A) 3.0">
                      SCPH-5001 (A) v3.0
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH5501_A_3.0" data-ini-key="SCPH-5501 (A) 3.0">
                      SCPH-5501 (A) v3.0
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH5503_A_3.0" data-ini-key="SCPH-5503 (A) 3.0">
                      SCPH-5503 (A) v3.0
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH7003_A_3.0" data-ini-key="SCPH-7003 (A) 3.0">
                      SCPH-7003 (A) v3.0
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH7000W_A_4.1" data-ini-key="SCPH-7000W (A) 4.1">
                      SCPH-7000W (A) v4.1
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH7001_A_4.1" data-ini-key="SCPH-7001 (A) 4.1">
                      SCPH-7001 (A) v4.1
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH7501_A_4.1" data-ini-key="SCPH-7501 (A) 4.1">
                      SCPH-7501 (A) v4.1
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH7503_A_4.1" data-ini-key="SCPH-7503 (A) 4.1">
                      SCPH-7503 (A) v4.1
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH9001_A_4.1" data-ini-key="SCPH-9001 (A) 4.1">
                      SCPH-9001 (A) v4.1
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH9003_A_4.1" data-ini-key="SCPH-9003 (A) 4.1">
                      SCPH-9003 (A) v4.1
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH9903_A_4.1" data-ini-key="SCPH-9903 (A) 4.1">
                      SCPH-9903 (A) v4.1
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH101_A_4.4" data-ini-key="SCPH-101 (A) 4.4">
                      SCPH-101 (A) v4.4
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH101_A_4.5" data-ini-key="SCPH-101 (A) 4.5">
                      SCPH-101 (A) v4.5
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH103_A_4.5" data-ini-key="SCPH-103 (A) 4.5">
                      SCPH-103 (A) v4.5
                    </label>
                  </li>
                </ul>
              </td>
              <!-- Region E -->
              <td>
                <ul>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH1002_E_2.0" data-ini-key="SCPH-1002 (E) 2.0">
                      SCPH-1002 (E) v2.0
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH1002_E_2.1" data-ini-key="SCPH-1002 (E) 2.1">
                      SCPH-1002 (E) v2.1
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH1002_E_2.2" data-ini-key="SCPH-1002 (E) 2.2">
                      SCPH-1002 (E) v2.2
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH5502_E_3.0" data-ini-key="SCPH-5502 (E) 3.0">
                      SCPH-5502 (E) v3.0
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH5552_E_3.0" data-ini-key="SCPH-5552 (E) 3.0">
                      SCPH-5552 (E) v3.0
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH7002_E_4.1" data-ini-key="SCPH-7002 (E) 4.1">
                      SCPH-7002 (E) v4.1
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH102_E_4.4" data-ini-key="SCPH-102 (E) 4.4">
                      SCPH-102 (E) v4.4
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS1BootCards_SCPH102_E_4.5" data-ini-key="SCPH-102 (E) 4.5">
                      SCPH-102 (E) v4.5
                    </label>
                  </li>
                </ul>
              </td>
            </tr>
          </tbody>
        </table>
      </fieldset>

      <!-- PS2 BootCards Section -->
      <fieldset id="ps2bootcards">
        <legend>PS2 BootCards</legend>
        <table>
          <thead>
            <tr>
              <th>PS2</th>
              <th>Arcade</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <ul>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS2BootCards_FMCB-1.966" data-ini-key="FMCB 1.966">
                      FMCB 1.966 (recommended)
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS2BootCards_FMCB-1.965" data-ini-key="FMCB 1.965">
                      FMCB 1.965
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS2BootCards_FMCB-1.964" data-ini-key="FMCB 1.964">
                      FMCB 1.964
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS2BootCards_FMCB-1.963" data-ini-key="FMCB 1.963">
                      FMCB 1.963
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS2BootCards_FMCB-1.953" data-ini-key="FMCB 1.953">
                      FMCB 1.953 (recommended for Modchip)
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS2BootCards_PS2BBL" data-ini-key="PS2BBL">
                      PS2BBL
                    </label>
                  </li>
                  <li>
                    <label>
                      <input type="checkbox" class="modern-checkbox" name="PS2BootCards_SlimTuna_64MB" data-ini-key="SlimTuna (64MB)">
                      SlimTuna (64MB)
                    </label>
                  </li>
                </ul>
              </td>
              <td>
                <ul>
                  <!-- Arcade column: no entries yet -->
                </ul>
              </td>
            </tr>
          </tbody>
        </table>
      </fieldset>

      <fieldset>
        <legend>CIV Data</legend>
        <label>
          8 Byte Hex CIV:
          <input type="text" name="CIV_Hex" placeholder="Enter 8 Hex Bytes" oninput="this.value = this.value.replace(/[^0-9a-fA-F]/g, '').slice(0,16)">
        </label>
      </fieldset>

      <button type="button" onclick="generateINI()">Download zip file</button>
    </form>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    // Clean pasted data for CIV input.
    const civInput = document.getElementsByName("CIV_Hex")[0];
    civInput.addEventListener("paste", function(e) {
      e.preventDefault();
      let pastedText = (e.clipboardData || window.clipboardData).getData("text");
      let cleaned = pastedText.replace(/[^0-9a-fA-F]/g, '').slice(0,16);
      this.value = cleaned;
    });

    // Mapping from PS1 bootcard model (data-ini-key) to the corresponding local filename.
    const bootcardFileMap = {
      "SCPH-1000 (I) 1.0": "superfast_1.0-1994-09-22-I-3b601fc8.mcd",
      "SCPH-3000 (I) 1.1": "superfast_1.1-1995-01-22-I-3539def6.mcd",
      "SCPH-3500 (I) 2.1": "superfast_2.1-1995-07-17-I-bc190209.mcd",
      "SCPH-5000 (I) 2.2": "superfast_2.2-1995-12-04-I-24fc7e17.mcd",
      "SCPH-5500 (I) 3.0": "superfast_3.0-1996-09-09-I-ff3eeb8c.mcd",
      "SCPH-7000 (I) 4.0": "superfast_4.0-1997-08-18-I-ec541cd0.mcd",
      "SCPH-100 (I) 4.3": "superfast_4.3-2000-03-11-I-f2af798b.mcd",
      "SCPH-1001 (A) 2.0": "superfast_2.0-1995-05-07-A-55847d8c.mcd",
      "SCPH-1001 (A) 2.1": "superfast_2.1-1995-07-17-A-aff00f2f.mcd",
      "SCPH-1001 (A) 2.2": "superfast_2.2-1995-12-04-A-37157331.mcd",
      "SCPH-5003 (A) 2.2": "superfast_2.2-1995-12-04-A-37157331.mcd",
      "SCPH-5001 (A) 3.0": "superfast_3.0-1996-11-18-A-8d8cb7e4.mcd",
      "SCPH-5501 (A) 3.0": "superfast_3.0-1996-11-18-A-8d8cb7e4.mcd",
      "SCPH-5503 (A) 3.0": "superfast_3.0-1996-11-18-A-8d8cb7e4.mcd",
      "SCPH-7003 (A) 3.0": "superfast_3.0-1996-11-18-A-8d8cb7e4.mcd",
      "SCPH-7000W (A) 4.1": "superfast_4.1-1997-11-14-A-b7c43dad.mcd",
      "SCPH-7001 (A) 4.1": "superfast_4.1-1997-12-16-A-502224b6.mcd",
      "SCPH-7501 (A) 4.1": "superfast_4.1-1997-12-16-A-502224b6.mcd",
      "SCPH-7503 (A) 4.1": "superfast_4.1-1997-12-16-A-502224b6.mcd",
      "SCPH-9001 (A) 4.1": "superfast_4.1-1997-12-16-A-502224b6.mcd",
      "SCPH-9003 (A) 4.1": "superfast_4.1-1997-12-16-A-502224b6.mcd",
      "SCPH-9903 (A) 4.1": "superfast_4.1-1997-12-16-A-502224b6.mcd",
      "SCPH-101 (A) 4.4": "superfast_4.4-2000-03-24-A-6a0e22a0.mcd",
      "SCPH-101 (A) 4.5": "superfast_4.5-2000-05-25-A-171bdcec.mcd",
      "SCPH-103 (A) 4.5": "superfast_4.5-2000-05-25-A-171bdcec.mcd",
      "SCPH-1002 (E) 2.0": "superfast_2.0-1995-05-10-E-9bb87c4b.mcd",
      "SCPH-1002 (E) 2.1": "superfast_2.1-1995-07-17-E-86c30531.mcd",
      "SCPH-1002 (E) 2.2": "superfast_2.2-1995-12-04-E-1e26792f.mcd",
      "SCPH-5502 (E) 3.0": "superfast_3.0-1997-01-06-E-d786f0b9.mcd",
      "SCPH-5552 (E) 3.0": "superfast_3.0-1997-01-06-E-d786f0b9.mcd",
      "SCPH-7002 (E) 4.1": "superfast_4.1-1997-12-16-E-318178bf.mcd",
      "SCPH-102 (E) 4.4": "superfast_4.4-2000-03-24-E-0bad7ea9.mcd",
      "SCPH-102 (E) 4.5": "superfast_4.5-2000-05-25-E-76b880e5.mcd"
    };

    // Mapping for PS2 BootCards.
    const ps2BootcardFileMap = {
      "FMCB 1.966": "FMCB_1966.mcd",
      "FMCB 1.965": "FMCB_1965.mcd",
      "FMCB 1.964": "FMCB_1964.mcd",
      "FMCB 1.963": "FMCB_1963.mcd",
      "FMCB 1.953": "FMCB_1953.mcd",
      "PS2BBL": "PS2BBL.mcd",
      "SlimTuna (64MB)": "SlimTuna.mcd"
    };

    // Since the files are now local, use a relative path (assume they are in the same directory)
    const bootcardBaseUrl = "./";

    // Modified generateINI function.
    async function generateINI() {
      const form = document.getElementById('settingsForm');
      let iniContent = "";
      const sections = {
        General: ['FlippedScreen', 'Mode'],
        PS1: ['PS1_Autoboot', 'PS1_GameID'],
        PS2: ['PS2_CardSize', 'PS2_Variant', 'PS2_Autoboot', 'PS2_GameID']
      };
      const sectionKeys = Object.keys(sections);
      sectionKeys.forEach((section, index) => {
        iniContent += `[${section}]\n`;
        sections[section].forEach(setting => {
          const element = form.elements[setting];
          let value;
          if (element.type === "checkbox") {
            value = element.checked ? "ON" : "OFF";
          } else if (element.type === "radio") {
            value = document.querySelector(`input[name="${setting}"]:checked`).value;
          } else {
            value = element.value;
          }
          const key = setting.replace("PS1_", "").replace("PS2_", "");
          iniContent += `${key}=${value}\n`;
        });
        // Only add a trailing newline after the last section.
        if (index === sectionKeys.length - 1) {
          iniContent += "\n";
        }
      });
      // Generate main settings.ini
      const zip = new JSZip();
      zip.file(".sd2psx/settings.ini", iniContent);

      // Generate BootCard.ini for PS1 only if at least one bootcard is selected.
      const bootCards = document.querySelectorAll("#ps1bootcards input[data-ini-key]");
      let enabledCards = Array.from(bootCards).filter(card => card.checked);
      if (enabledCards.length > 0) {
        let maxChannels = enabledCards.length;
        let bootCardContent = "[ChannelName]\n";
        enabledCards.forEach((card, index) => {
          let channelName = card.closest("label").textContent.trim();
          bootCardContent += `${index + 1}=${channelName}\n`;
        });
        bootCardContent += "[Settings]\n";
        bootCardContent += `MaxChannels=${maxChannels}\n`;
        const ps2CardSize = form.elements["PS2_CardSize"].value;
        bootCardContent += `CardSize=${ps2CardSize}\n\n`;
        zip.file("MemoryCards/PS1/BOOT/BootCard.ini", bootCardContent);

        // Add each selected PS1 bootcard file.
        for (let i = 0; i < enabledCards.length; i++) {
          const card = enabledCards[i];
          const key = card.getAttribute("data-ini-key");
          const filename = bootcardFileMap[key];
          if (filename) {
            const fileUrl = bootcardBaseUrl + filename;
            try {
              const response = await fetch(fileUrl);
              if (!response.ok) throw new Error(`Failed to fetch ${fileUrl}`);
              const fileData = await response.blob();
              zip.file("MemoryCards/PS1/BOOT/BootCard-" + (i + 1) + ".mcd", fileData);
            } catch (err) {
              console.error(err);
            }
          } else {
            console.warn(`No file mapping found for bootcard key: ${key}`);
          }
        }
      }

      // Generate BootCard.ini for PS2 only if at least one bootcard is selected.
      const ps2BootCards = document.querySelectorAll("#ps2bootcards input[data-ini-key]");
      let enabledPS2Cards = Array.from(ps2BootCards).filter(card => card.checked);
      if (enabledPS2Cards.length > 0) {
        let ps2MaxChannels = enabledPS2Cards.length;
        let ps2BootCardContent = "[ChannelName]\n";
        enabledPS2Cards.forEach((card, index) => {
          let channelName = card.closest("label").textContent.trim();
          ps2BootCardContent += `${index + 1}=${channelName}\n`;
        });
        ps2BootCardContent += "[Settings]\n";
        ps2BootCardContent += `MaxChannels=${ps2MaxChannels}\n`;
        const ps2CardSizeValue = form.elements["PS2_CardSize"].value;
        ps2BootCardContent += `CardSize=${ps2CardSizeValue}\n\n`;
        zip.file("MemoryCards/PS2/BOOT/BootCard.ini", ps2BootCardContent);

        // Add each selected PS2 bootcard file.
        for (let i = 0; i < enabledPS2Cards.length; i++) {
          const card = enabledPS2Cards[i];
          const key = card.getAttribute("data-ini-key");
          const filename = ps2BootcardFileMap[key];
          if (filename) {
            const fileUrl = bootcardBaseUrl + filename;
            try {
              const response = await fetch(fileUrl);
              if (!response.ok) throw new Error(`Failed to fetch ${fileUrl}`);
              const fileData = await response.blob();
              zip.file("MemoryCards/PS2/BOOT/BootCard-" + (i + 1) + ".mcd", fileData);
            } catch (err) {
              console.error(err);
            }
          } else {
            console.warn(`No file mapping found for PS2 bootcard key: ${key}`);
          }
        }
      }

      // Add CIV data if valid.
      let civRaw = civInput.value;
      let civClean = civRaw.replace(/[^0-9a-fA-F]/g, "");
      if (civClean.length === 16) {
        const binData = hexToUint8Array(civClean);
        zip.file(".sd2psx/civ.bin", binData);
      } else if (civClean !== "") {
        console.error("Invalid CIV hex string. After cleaning, it must contain exactly 16 hex digits.");
      }

      zip.generateAsync({ type: "blob" }).then(content => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "settings.zip";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    }

    // Helper function to convert a hex string to a Uint8Array.
    function hexToUint8Array(hex) {
      const len = hex.length;
      let arr = new Uint8Array(len / 2);
      for (let i = 0; i < len; i += 2) {
        arr[i / 2] = parseInt(hex.substr(i, 2), 16);
      }
      return arr;
    }

    // Drag & drop file handling
    const dropZone = document.getElementById('dropZone');
    const iniFileInput = document.getElementById('iniFile');

    dropZone.addEventListener('click', () => {
      iniFileInput.click();
    });

    iniFileInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('hover');
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.classList.remove('hover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('hover');
      if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
        handleFile(e.dataTransfer.files[0]);
        e.dataTransfer.clearData();
      }
    });

    // Reads the dropped or selected INI file, updates the drop zone text, and parses its content.
    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        console.log("INI file content:", content);
        dropZone.textContent = file.name;
        parseINI(content);
      };
      reader.onerror = function(e) {
        console.error("Error reading file", e);
      };
      reader.readAsText(file);
    }

    // Parse an INI file's content and update the form fields.
    function parseINI(content) {
      document.getElementById('settingsForm').reset();
      const lines = content.split(/\r?\n/);
      let currentSection = null;
      lines.forEach(line => {
        line = line.trim();
        if (!line || line.startsWith(";") || line.startsWith("#")) return;
        if (line.startsWith("[") && line.endsWith("]")) {
          currentSection = line.slice(1, -1);
        } else if (currentSection && line.includes("=")) {
          const parts = line.split("=");
          const key = parts[0].trim();
          const value = parts.slice(1).join("=").trim();
          updateField(currentSection, key, value);
        }
      });
    }

    function updateField(section, key, value) {
      let fieldName;
      if (section === "General") {
        fieldName = key;
      } else if (section === "PS1BootCards") {
        const candidates = document.querySelectorAll("#ps1bootcards input[data-ini-key]");
        candidates.forEach(candidate => {
          if (candidate.getAttribute("data-ini-key") === key) {
            fieldName = candidate.name;
          }
        });
      } else {
        fieldName = section + "_" + key;
      }
      const element = document.getElementsByName(fieldName)[0];
      if (!element) {
        console.warn(`No field found for ${fieldName}`);
        return;
      }
      if (element.type === "checkbox") {
        element.checked = (value.toUpperCase() === "ON");
      } else if (element.type === "radio") {
        const radio = document.querySelector(`input[name="${fieldName}"][value="${value.toUpperCase()}"]`);
        if (radio) {
          radio.checked = true;
        }
      } else {
        element.value = value;
      }
    }
  </script>
</body>
</html>
